<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dark Angel - Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        :root {
            --wa-bg: #0b141a;
            --wa-panel: #111b21;
            --wa-sent: #005c4b;
            --wa-received: #202c33;
            --wa-input-bg: #2a3942;
        }

        body, html { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #000; 
            margin: 0; 
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--wa-bg);
            margin: 0 auto;
            position: relative;
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 500px;
                border-left: 1px solid #222e35;
                border-right: 1px solid #222e35;
            }
        }

        .chat-wallpaper {
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat;
            opacity: 0.06;
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        #chat-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            z-index: 10;
            padding: 12px;
            scrollbar-width: none;
        }
        #chat-content::-webkit-scrollbar { display: none; }

        .bubble {
            max-width: 85%;
            padding: 8px 12px;
            font-size: 15px;
            margin-bottom: 8px;
            position: relative;
            box-shadow: 0 1px 1px rgba(0,0,0,0.2);
            word-wrap: break-word;
            animation: slideUp 0.2s ease-out;
        }

        .sent {
            background-color: var(--wa-sent);
            align-self: flex-end;
            border-radius: 12px 0px 12px 12px;
            color: #fff;
        }

        .received {
            background-color: var(--wa-received);
            align-self: flex-start;
            border-radius: 0px 12px 12px 12px;
            color: #e9edef;
        }

        .input-area {
            background-color: var(--wa-panel);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 50;
        }

        .input-wrapper {
            background-color: var(--wa-input-bg);
            border-radius: 24px;
            display: flex;
            align-items: center;
            flex: 1;
            padding: 0 12px;
            min-height: 44px;
        }

        .send-btn {
            background-color: #00a884;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            flex-shrink: 0;
            cursor: pointer;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="app" class="app-container">
        <div class="flex-1 flex items-center justify-center">
            <div class="w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, addDoc, query, onSnapshot, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const MASTER_KEY = "dark_angel";
        
        // Nome fixo da coleção para as mensagens não sumirem nunca mais
        const DB_COLLECTION_PREFIX = "dark_angel_v1_permanent";

        const firebaseConfig = {
            apiKey: "AIzaSyAAKqeX0Aq0n4OzgilX-5Q1PPVoSiPXCIc",
            authDomain: "chat-geral-a3bba.firebaseapp.com",
            projectId: "chat-geral-a3bba",
            storageBucket: "chat-geral-a3bba.firebasestorage.app",
            messagingSenderId: "1007033326627",
            appId: "1:1007033326627:web:26f07d61a8f9ba1f642596"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const root = document.getElementById('app');

        let myData = JSON.parse(localStorage.getItem('da_user_data'));

        async function start() {
            await signInAnonymously(auth);
            if (sessionStorage.getItem('da_logged')) {
                myData ? showDashboard() : showOnboarding();
            } else {
                showLock();
            }
        }

        function showLock() {
            root.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center p-10 text-center space-y-8">
                    <div class="w-20 h-20 bg-emerald-600 rounded-3xl flex items-center justify-center shadow-2xl">
                        <i class="fa-solid fa-bolt-lightning text-white text-3xl"></i>
                    </div>
                    <div>
                        <h1 class="text-white text-xl font-black italic uppercase tracking-widest">Dark Angel</h1>
                        <p class="text-zinc-500 text-[10px] uppercase font-bold mt-1">Terminal de Acesso</p>
                    </div>
                    <div class="w-full space-y-3">
                        <input type="password" id="key-in" placeholder="CHAVE" class="w-full bg-[#111b21] border border-white/5 p-4 rounded-xl text-center text-white outline-none focus:border-emerald-500">
                        <button id="key-btn" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase tracking-widest active:scale-95 transition-transform">Entrar</button>
                    </div>
                </div>`;
            document.getElementById('key-btn').onclick = () => {
                if (document.getElementById('key-in').value === MASTER_KEY) {
                    sessionStorage.setItem('da_logged', 'true');
                    myData ? showDashboard() : showOnboarding();
                }
            };
        }

        function showOnboarding() {
            root.innerHTML = `
                <div class="flex-1 flex flex-col items-center justify-center p-6 space-y-6">
                    <div class="bg-[#111b21] w-full p-8 rounded-3xl border border-white/5 shadow-2xl">
                        <h2 class="text-emerald-500 font-black text-center mb-6 uppercase italic text-sm">Registar Agente</h2>
                        <div class="w-24 h-24 mx-auto mb-6 bg-zinc-800 rounded-2xl overflow-hidden border-2 border-emerald-500/30">
                            <img id="avatar-pre" src="https://api.dicebear.com/7.x/bottts/svg?seed=Dark" class="w-full h-full object-cover">
                        </div>
                        <input type="text" id="name-in" placeholder="NOME DO AGENTE" class="w-full bg-[#0b141a] border border-white/5 p-4 rounded-xl text-center text-white font-bold uppercase outline-none focus:border-emerald-500 mb-4">
                        <button id="reg-btn" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase">Criar Perfil</button>
                    </div>
                </div>`;
            document.getElementById('reg-btn').onclick = () => {
                const name = document.getElementById('name-in').value.trim().toUpperCase();
                if(name.length < 2) return;
                myData = { uid: auth.currentUser.uid, name, photo: `https://api.dicebear.com/7.x/bottts/svg?seed=${name}` };
                localStorage.setItem('da_user_data', JSON.stringify(myData));
                setDoc(doc(db, 'da_permanent_users', myData.uid), myData);
                showDashboard();
            };
        }

        function showDashboard() {
            root.innerHTML = `
                <div class="flex flex-col h-full">
                    <header class="p-4 bg-[#111b21] flex justify-between items-center shadow-md z-30">
                        <div class="flex items-center gap-3">
                            <img src="${myData.photo}" class="w-10 h-10 rounded-full">
                            <span class="text-white font-bold text-sm italic uppercase">${myData.name}</span>
                        </div>
                        <i class="fa-solid fa-ghost text-emerald-500"></i>
                    </header>
                    <div class="flex-1 overflow-y-auto p-4 space-y-4">
                        <div id="btn-g" class="p-5 bg-emerald-600/10 border border-emerald-500/20 rounded-2xl flex items-center gap-4 cursor-pointer active:bg-emerald-600/20">
                            <div class="w-12 h-12 bg-emerald-600 rounded-full flex items-center justify-center text-white shadow-lg"><i class="fa-solid fa-globe"></i></div>
                            <div>
                                <h3 class="text-emerald-400 font-black italic uppercase">Chat Global</h3>
                                <p class="text-[9px] text-zinc-500 font-bold uppercase tracking-widest">Histórico Permanente</p>
                            </div>
                        </div>
                        <div id="user-list" class="space-y-1"></div>
                    </div>
                </div>`;

            document.getElementById('btn-g').onclick = () => openChat('global');
            onSnapshot(collection(db, 'da_permanent_users'), (snap) => {
                const list = document.getElementById('user-list');
                if(!list) return;
                list.innerHTML = '<p class="text-[10px] font-black text-zinc-600 uppercase tracking-widest my-4">Agentes Ativos</p>';
                snap.forEach(d => {
                    const u = d.data();
                    if(u.uid === myData.uid) return;
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-4 p-3 hover:bg-[#111b21] rounded-xl cursor-pointer active:bg-[#111b21]";
                    div.innerHTML = `<img src="${u.photo}" class="w-12 h-12 rounded-full"><div class="flex-1 border-b border-white/5 pb-2"><div class="text-white font-bold uppercase italic text-sm">${u.name}</div><div class="text-[10px] text-emerald-500 uppercase font-black">Disponível</div></div>`;
                    div.onclick = () => openChat('dm', u);
                    list.appendChild(div);
                });
            });
        }

        function openChat(type, target = null) {
            root.innerHTML = `
                <div class="flex flex-col h-full relative">
                    <div class="chat-wallpaper"></div>
                    <header class="p-3 bg-[#111b21] flex items-center gap-3 shadow-lg z-20">
                        <button id="chat-back" class="p-2 text-zinc-400"><i class="fa-solid fa-arrow-left"></i></button>
                        <img src="${type === 'global' ? 'https://api.dicebear.com/7.x/shapes/svg?seed=G' : target.photo}" class="w-10 h-10 rounded-full">
                        <div class="flex-1">
                            <h2 class="text-white font-black text-sm uppercase italic truncate">${type === 'global' ? 'Chat Global' : target.name}</h2>
                            <span class="text-[9px] text-emerald-500 font-bold uppercase">Base de Dados V1</span>
                        </div>
                    </header>
                    
                    <div id="chat-content"></div>
                    
                    <div class="input-area">
                        <div class="input-wrapper">
                            <i class="fa-regular fa-face-smile text-zinc-400 mr-2 text-lg"></i>
                            <input type="text" id="msg-in" placeholder="Mensagem" class="flex-1 bg-transparent border-none outline-none text-white text-[16px] py-2" autocomplete="off">
                        </div>
                        <button id="msg-btn" class="send-btn">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>`;

            document.getElementById('chat-back').onclick = showDashboard;
            
            // O caminho agora é fixo para nunca perder as mensagens
            const channel = type === 'global' ? `${DB_COLLECTION_PREFIX}_global` : `${DB_COLLECTION_PREFIX}_dm_${[myData.uid, target.uid].sort().join('_')}`;
            
            onSnapshot(query(collection(db, channel), orderBy('timestamp', 'asc'), limit(150)), (snap) => {
                const box = document.getElementById('chat-content');
                if(!box) return;
                box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.sid === myData.uid;
                    const el = document.createElement('div');
                    el.className = `bubble ${isMe ? 'sent' : 'received'}`;
                    el.innerHTML = `
                        ${!isMe ? `<div class="text-[10px] font-black text-emerald-400 uppercase italic mb-1">${m.author}</div>` : ''}
                        <div>${m.text}</div>
                        <div class="flex justify-end mt-1 items-center gap-1">
                            <span class="text-[8px] text-zinc-400 font-bold uppercase">${m.timestamp ? new Date(m.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</span>
                            ${isMe ? '<i class="fa-solid fa-check-double text-[8px] text-sky-400"></i>' : ''}
                        </div>`;
                    box.appendChild(el);
                });
                box.scrollTop = box.scrollHeight;
            });

            const send = async () => {
                const input = document.getElementById('msg-in');
                const val = input.value.trim();
                if(!val) return;
                input.value = '';
                await addDoc(collection(db, channel), { text: val, sid: myData.uid, author: myData.name, timestamp: serverTimestamp() });
            };

            document.getElementById('msg-btn').onclick = send;
            document.getElementById('msg-in').onkeypress = (e) => { if(e.key === 'Enter') send(); };
        }

        start();
    </script>
</body>
</html>

